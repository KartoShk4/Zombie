/* ============================================
   SPATIAL GRID — УСКОРЕНИЕ СТОЛКНОВЕНИЙ
   ============================================
   Пространственная сетка для оптимизации
   проверки столкновений. Разделяет игровой
   мир на ячейки для быстрого поиска объектов
   в определенной области.
   ============================================ */

// ===== ПАРАМЕТРЫ СЕТКИ =====
/**
 * Размер ячейки сетки в пикселях
 * Объекты в одной ячейке проверяются на столкновение друг с другом
 */
const GRID_CELL = 250;

/**
 * Количество столбцов сетки
 * Рассчитывается на основе ширины мира (WORLD_WIDTH = 3000)
 */
const GRID_COLS = Math.ceil(3000 / GRID_CELL);

/**
 * Количество строк сетки
 * Рассчитывается на основе высоты мира (WORLD_HEIGHT = 3000)
 */
const GRID_ROWS = Math.ceil(3000 / GRID_CELL);

// ===== ДАННЫЕ СЕТКИ =====
/**
 * Сетка: массив массивов объектов
 * Каждая ячейка содержит массив объектов, находящихся в этой ячейке
 */
let grid = [];

// ===== ФУНКЦИИ РАБОТЫ С СЕТКОЙ =====
/**
 * Очистка сетки
 * Удаляет все объекты из всех ячеек
 * Вызывается каждый кадр перед добавлением объектов
 */
function gridClear() {
    grid = [];
    // Инициализируем пустые массивы для каждой ячейки
    for (let i = 0; i < GRID_COLS * GRID_ROWS; i++) {
        grid[i] = [];
    }
}

/**
 * Получить индекс ячейки по координатам
 * @param {number} x - Координата X объекта
 * @param {number} y - Координата Y объекта
 * @returns {number} Индекс ячейки или -1 если координаты вне границ
 */
function gridIndex(x, y) {
    const cx = Math.floor(x / GRID_CELL);  // Столбец
    const cy = Math.floor(y / GRID_CELL);  // Строка
    // Проверяем границы
    if (cx < 0 || cy < 0 || cx >= GRID_COLS || cy >= GRID_ROWS) return -1;
    // Вычисляем индекс: строка * количество столбцов + столбец
    return cy * GRID_COLS + cx;
}

/**
 * Добавить объект в сетку
 * Помещает объект в соответствующую ячейку на основе его координат
 * @param {Object} obj - Объект с координатами x и y
 */
function gridAdd(obj) {
    const idx = gridIndex(obj.x, obj.y);
    if (idx >= 0) grid[idx].push(obj);
}

/**
 * Получить объекты из соседних ячеек
 * Возвращает все объекты из текущей ячейки и 8 соседних ячеек
 * Используется для проверки столкновений (пули с зомби, зомби друг с другом)
 * @param {number} x - Координата X
 * @param {number} y - Координата Y
 * @returns {Array} Массив объектов из соседних ячеек
 */
function gridGetNeighbors(x, y) {
    const cx = Math.floor(x / GRID_CELL);  // Столбец текущей ячейки
    const cy = Math.floor(y / GRID_CELL);  // Строка текущей ячейки

    const result = [];

    // Проверяем текущую ячейку и 8 соседних (3x3 сетка)
    for (let iy = -1; iy <= 1; iy++) {
        for (let ix = -1; ix <= 1; ix++) {
            const nx = cx + ix;  // Столбец соседней ячейки
            const ny = cy + iy;  // Строка соседней ячейки
            // Проверяем границы
            if (nx >= 0 && ny >= 0 && nx < GRID_COLS && ny < GRID_ROWS) {
                const idx = ny * GRID_COLS + nx;
                // Добавляем все объекты из этой ячейки
                result.push(...grid[idx]);
            }
        }
    }

    return result;
}
